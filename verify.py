#-*- coding:utf-8 -*-
import difflib
from PIL import Image
import requests

imgNum = 100
threshold = 140

info = {
    "offsetWidth": 2,   #宽度偏移
    "offsetHeight": 4,  #高度偏移
    "wordNum": 4,       #字符数量
    "wordWidth": 12,    #字符宽度
    "wordHeight": 12,   #字符高度
    "wordSpace": -2     #字符空隙
}

keys = {
  "c": "111111111111111111111111111111111111111100001111111000000111110001101111110011111111110011111111110011111111110001111111111000001111111100011111",
  "b": "111111111111110011111111110011111111110000001111110000000111110001100011110011110011110011110011110011110011110001100011110000000111111000001111",
  "m": "111111111111111111111111111111111111111000001100110000000000110001000010110011100111110011100111110011100111110011100111110011100111111111111111",
  "n": "111111111111111111111111111111111111111000000111110000000011110001100011110011110011110011110011110011110011110011110011110011110011111111111111",
  "1": "111110111111111100011111111000011111111000011111111110011111111110011111111110011111111110011111111110011111111110011111111110011111111111111111",
  "3": "111000001111110000000111111111000111111111000111111110001111111110001111111111000111111111100111110111100111100011000111110000001111111000011111",
  "2": "111000011111110000001111100011000111110111100111111111100111111111001111111110001111111100011111111000111111110000111111100000001111110000001111",
  "v": "111111111111111111111111111111111111111111111111110011100111110011100111111001001111111000001111111000001111111100011111111100011111111110111111",
  "x": "111111111111111111111111111111111111111011101111110001000111111000001111111100011111111100011111111100011111111000001111110001000111111011101111",
  "z": "111111111111111111111111111111111111111000001111111000000111111110001111111110001111111100011111111000111111111000111111110000001111111000001111"
}

"""
rcookies = requests.get('http://kdjw.hnust.cn/kdjw/verifycode.servlet').cookies
for i in range(imgNum):
    img = requests.get('http://kdjw.hnust.cn/kdjw/verifycode.servlet', cookies=cookies).content
    with open('code/%s.jpg' % i, 'w') as f:
        f.write(img)
"""

for i in range(imgNum):
    codes = code = ""
    im = Image.open("code/%s.jpg" % i).convert('L')
    #分割单个字符
    for j in range(info['wordNum']):
        beginX = info['offsetWidth'] + (info['wordWidth'] + info['wordSpace']) * j
        beginY = info['offsetHeight']
        endX = beginX + info['wordWidth']
        endY = beginY + info['wordHeight']
        box = (beginX, beginY, endX, endY)
        imgData = ''.join(['0' if x > threshold else '1' for x in list(im.crop(box).getdata())])
        percent = maxPercent = 0.0
        #选取相似度最大的值
        for key in keys:
            percent = difflib.SequenceMatcher(None, imgData, keys[key]).ratio()
            if percent > maxPercent:
                maxPercent = percent
                code = key
        codes += code
    print i, codes